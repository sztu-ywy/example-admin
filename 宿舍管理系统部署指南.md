# 宿舍管理系统部署指南

## 1. 部署环境要求

### 1.1 硬件要求

| 组件 | 最低配置 | 推荐配置 | 生产环境 |
|------|----------|----------|----------|
| CPU | 2核 | 4核 | 8核+ |
| 内存 | 4GB | 8GB | 16GB+ |
| 存储 | 50GB | 100GB | 500GB+ |
| 网络 | 100Mbps | 1Gbps | 10Gbps |

### 1.2 软件环境

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| 操作系统 | Ubuntu 20.04+ / CentOS 8+ | 推荐Ubuntu 22.04 LTS |
| Docker | 20.10+ | 容器化部署 |
| Docker Compose | 2.0+ | 容器编排 |
| Nginx | 1.18+ | 反向代理和负载均衡 |
| MySQL | 8.0+ | 主数据库 |
| Redis | 6.0+ | 缓存数据库 |

## 2. 快速部署（Docker方式）

### 2.1 准备部署文件

创建部署目录结构：
```bash
mkdir -p /opt/dormitory-system/{config,data,logs}
cd /opt/dormitory-system
```

### 2.2 Docker Compose配置

创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: dormitory-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: dormitory
      MYSQL_USER: dormitory
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - dormitory-network

  # Redis缓存
  redis:
    image: redis:6.2-alpine
    container_name: dormitory-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    ports:
      - "6379:6379"
    networks:
      - dormitory-network

  # 后端API服务
  api:
    build:
      context: ./dormitory-api
      dockerfile: Dockerfile
    container_name: dormitory-api
    restart: always
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=dormitory
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_NAME=dormitory
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./logs/api:/app/logs
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    networks:
      - dormitory-network

  # 前端Web服务
  web:
    build:
      context: ./dormitory-web
      dockerfile: Dockerfile
    container_name: dormitory-web
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./config/ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api
    networks:
      - dormitory-network

networks:
  dormitory-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
```

### 2.3 环境变量配置

创建 `.env` 文件：

```bash
# 数据库配置
MYSQL_ROOT_PASSWORD=your_strong_root_password
MYSQL_PASSWORD=your_strong_password

# Redis配置
REDIS_PASSWORD=your_redis_password

# JWT密钥
JWT_SECRET=your_jwt_secret_key_at_least_32_characters

# 应用配置
APP_ENV=production
APP_DEBUG=false
```

### 2.4 Nginx配置

创建 `config/nginx/nginx.conf`：

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    # 基本配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 50M;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/xml+rss 
               application/json application/xml;
    
    # 上游服务器
    upstream api_backend {
        server api:8080;
        keepalive 32;
    }
    
    # HTTP服务器（重定向到HTTPS）
    server {
        listen 80;
        server_name _;
        return 301 https://$server_name$request_uri;
    }
    
    # HTTPS服务器
    server {
        listen 443 ssl http2;
        server_name your-domain.com;
        
        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        
        # 现代SSL配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=63072000" always;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # 前端静态文件
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
            
            # 缓存配置
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
        
        # API代理
        location /api/ {
            proxy_pass http://api_backend/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            
            # 超时配置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

### 2.5 部署执行

```bash
# 1. 克隆代码
git clone https://github.com/your-org/dormitory-system.git
cd dormitory-system

# 2. 设置权限
chmod +x run_tests.sh
chmod 600 .env

# 3. 构建并启动服务
docker-compose up -d --build

# 4. 检查服务状态
docker-compose ps

# 5. 查看日志
docker-compose logs -f
```

## 3. 生产环境部署

### 3.1 高可用架构

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │    (HAProxy)    │
                    └─────────┬───────┘
                              │
                    ┌─────────┴───────┐
                    │                 │
            ┌───────▼────────┐ ┌──────▼────────┐
            │   Web Server   │ │  Web Server   │
            │   (Nginx 1)    │ │  (Nginx 2)    │
            └───────┬────────┘ └──────┬────────┘
                    │                 │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │                 │
            ┌───────▼────────┐ ┌──────▼────────┐
            │  API Server    │ │  API Server   │
            │     (Go 1)     │ │     (Go 2)    │
            └───────┬────────┘ └──────┬────────┘
                    │                 │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │                 │
            ┌───────▼────────┐ ┌──────▼────────┐
            │  MySQL Master  │ │ MySQL Slave   │
            │   (Primary)    │ │  (Replica)    │
            └────────────────┘ └───────────────┘
                    │
            ┌───────▼────────┐
            │ Redis Cluster  │
            │   (3 nodes)    │
            └────────────────┘
```

### 3.2 监控配置

创建 `monitoring/docker-compose.yml`：

```yaml
version: '3.8'

services:
  # Prometheus监控
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  # Grafana可视化
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources

  # 日志收集
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.15.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:7.15.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch

volumes:
  prometheus-data:
  grafana-data:
  elasticsearch-data:
```

### 3.3 备份脚本

创建 `scripts/backup.sh`：

```bash
#!/bin/bash

# 宿舍管理系统备份脚本
BACKUP_DIR="/opt/backups/dormitory"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_CONTAINER="dormitory-mysql"
REDIS_CONTAINER="dormitory-redis"

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# MySQL备份
echo "开始MySQL备份..."
docker exec $MYSQL_CONTAINER mysqldump -u root -p$MYSQL_ROOT_PASSWORD dormitory > $BACKUP_DIR/$DATE/mysql_backup.sql

# Redis备份
echo "开始Redis备份..."
docker exec $REDIS_CONTAINER redis-cli --rdb /data/dump.rdb
docker cp $REDIS_CONTAINER:/data/dump.rdb $BACKUP_DIR/$DATE/redis_backup.rdb

# 应用文件备份
echo "开始应用文件备份..."
tar -czf $BACKUP_DIR/$DATE/app_backup.tar.gz /opt/dormitory-system

# 清理旧备份（保留7天）
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;

echo "备份完成: $BACKUP_DIR/$DATE"
```

## 4. 运维管理

### 4.1 服务管理命令

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启特定服务
docker-compose restart api

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f api

# 进入容器
docker-compose exec api bash

# 更新服务
docker-compose pull
docker-compose up -d --force-recreate
```

### 4.2 健康检查

创建 `scripts/health_check.sh`：

```bash
#!/bin/bash

# 健康检查脚本
API_URL="http://localhost:8080"
WEB_URL="http://localhost"

# 检查API服务
if curl -f -s $API_URL/health > /dev/null; then
    echo "✅ API服务正常"
else
    echo "❌ API服务异常"
    # 发送告警通知
    # curl -X POST "https://hooks.slack.com/..." -d '{"text":"API服务异常"}'
fi

# 检查Web服务
if curl -f -s $WEB_URL > /dev/null; then
    echo "✅ Web服务正常"
else
    echo "❌ Web服务异常"
fi

# 检查数据库连接
if docker exec dormitory-mysql mysqladmin ping -h localhost > /dev/null 2>&1; then
    echo "✅ MySQL服务正常"
else
    echo "❌ MySQL服务异常"
fi

# 检查Redis连接
if docker exec dormitory-redis redis-cli ping > /dev/null 2>&1; then
    echo "✅ Redis服务正常"
else
    echo "❌ Redis服务异常"
fi
```

### 4.3 性能优化

```bash
# 系统优化
echo 'vm.max_map_count=262144' >> /etc/sysctl.conf
echo 'fs.file-max=65536' >> /etc/sysctl.conf
sysctl -p

# Docker优化
echo '{"log-driver":"json-file","log-opts":{"max-size":"10m","max-file":"3"}}' > /etc/docker/daemon.json
systemctl restart docker

# MySQL优化
# 在my.cnf中添加：
# innodb_buffer_pool_size = 1G
# innodb_log_file_size = 256M
# max_connections = 1000
```

## 5. 故障排除

### 5.1 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 容器启动失败 | 端口冲突 | 检查端口占用，修改配置 |
| 数据库连接失败 | 密码错误 | 检查环境变量配置 |
| 前端页面空白 | 构建失败 | 重新构建前端镜像 |
| API响应慢 | 数据库性能 | 优化查询，添加索引 |
| 内存不足 | 资源限制 | 增加服务器内存 |

### 5.2 日志分析

```bash
# 查看错误日志
docker-compose logs api | grep ERROR

# 分析访问日志
tail -f logs/nginx/access.log | grep -v "200\|301\|302"

# 监控资源使用
docker stats

# 查看系统资源
htop
iostat -x 1
```

## 6. 安全加固

### 6.1 系统安全

```bash
# 更新系统
apt update && apt upgrade -y

# 配置防火墙
ufw enable
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp

# 禁用root登录
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
systemctl restart ssh
```

### 6.2 应用安全

- 定期更新依赖包
- 使用强密码策略
- 启用HTTPS
- 配置安全头
- 定期安全扫描

这份部署指南提供了从开发环境到生产环境的完整部署方案，包括监控、备份、运维等各个方面的详细说明。
